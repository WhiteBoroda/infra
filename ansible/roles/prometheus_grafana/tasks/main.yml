- name: Create monitoring namespace
  shell: kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Add Helm repo for Prometheus and Grafana
  shell: |
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    helm repo add grafana https://grafana.github.io/helm-charts
    helm repo update
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Install Prometheus stack
  shell: |
    helm install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \
      --set grafana.enabled=false
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Install Grafana
  shell: |
    helm install grafana grafana/grafana \
      --namespace monitoring \
      --set adminUser={{ grafana_admin_user }} \
      --set adminPassword={{ grafana_admin_password }} \
      --set service.type=LoadBalancer \
      --set service.loadBalancerIP={{ grafana_loadbalancer_ip}} \
      --set persistence.enabled=true \
      --set persistence.size=5Gi
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Copy Grafana dashboards
  copy:
    src: files/dashboards/
    dest: /tmp/grafana_dashboards/

- name: Import dashboards into Grafana
  shell: |
    for f in /tmp/grafana_dashboards/*.json; do
      curl -X POST http://{{ grafana_admin_user }}:{{ grafana_admin_password }}@{{ grafana_loadbalancer_ip }}:3000/api/dashboards/db \
        -H "Content-Type: application/json" \
        -d @"$f";
    done

- name: Expose Grafana dashboard via Ingress
  shell: |
    kubectl apply -f - <<EOF
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: grafana-ingress
      namespace: monitoring
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: letsencrypt-staging
    spec:
      tls:
      - hosts:
        - grafana.local
        secretName: grafana-tls
      rules:
      - host: grafana.local
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: grafana
                port:
                  number: 80
    EOF
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Print Grafana credentials
  debug:
    msg: "Grafana URL: https://grafana.local | User: {{ grafana_admin_user }} | Password: {{ grafana_admin_password }}"
