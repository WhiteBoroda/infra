---
# Molecule verification playbook for odoo_cluster role
- name: Verify
  hosts: all
  gather_facts: true
  tasks:
    - name: Check if kubectl is configured
      ansible.builtin.command: kubectl version --client
      register: kubectl_version
      changed_when: false
      failed_when: kubectl_version.rc != 0

    - name: Display kubectl version
      ansible.builtin.debug:
        msg: "Kubectl version: {{ kubectl_version.stdout }}"

    - name: Check for Odoo namespace
      ansible.builtin.command: kubectl get namespace odoo-prod
      register: odoo_namespace
      changed_when: false
      ignore_errors: true

    - name: Check for Odoo deployment manifest
      ansible.builtin.stat:
        path: /tmp/odoo-deployment.yaml
      register: odoo_manifest
      ignore_errors: true

    - name: Verify deployment preparation
      ansible.builtin.assert:
        that:
          - kubectl_version.rc == 0
        fail_msg: "Kubectl is not properly configured"
        success_msg: "Kubectl configuration verified"
