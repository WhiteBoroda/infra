- name: Install Docker
  apt:
    name: [apt-transport-https, ca-certificates, curl, software-properties-common]
    state: present

- name: Add Docker GPG key
  shell: curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -

- name: Install Docker engine
  shell: |
    add-apt-repository -y "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    apt update && apt install docker-ce -y

- name: Stop and remove existing monitoring containers
  shell: |
    docker stop prometheus grafana alertmanager 2>/dev/null || true
    docker rm prometheus grafana alertmanager 2>/dev/null || true
  ignore_errors: yes

- name: Create monitoring network
  shell: docker network create monitoring || true
  ignore_errors: yes

- name: Run Prometheus
  shell: |
    docker run -d --name prometheus --network monitoring \
      --restart unless-stopped \
      -p 9090:9090 \
      prom/prometheus

- name: Run Grafana
  shell: |
    docker run -d --name grafana --network monitoring \
      --restart unless-stopped \
      -p 3000:3000 \
      grafana/grafana

- name: Run Alertmanager
  shell: |
    docker run -d --name alertmanager --network monitoring \
      --restart unless-stopped \
      -p 9093:9093 \
      prom/alertmanager