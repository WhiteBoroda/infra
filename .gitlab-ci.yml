# GitLab CI/CD Pipeline for Odoo Cluster

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  HELM_VERSION: "3.13.0"
  KUBECTL_VERSION: "1.28.0"
  K8S_NAMESPACE_DEV: "odoo-dev"
  K8S_NAMESPACE_STAGE: "odoo-stage"
  K8S_NAMESPACE_PROD: "odoo-prod"

stages:
  - lint
  - build
  - test
  - security
  - deploy-dev
  - deploy-stage
  - deploy-prod
  - performance-test

# Templates
.kubectl_config: &kubectl_config
  - mkdir -p ~/.kube
  - echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
  - chmod 600 ~/.kube/config

.helm_install: &helm_install
  - curl -fsSL https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz | tar -xz
  - mv linux-amd64/helm /usr/local/bin/
  - helm version

# ============================================
# LINT STAGE
# ============================================

lint:yaml:
  stage: lint
  image: cytopia/yamllint:latest
  script:
    - yamllint -c .yamllint k8s/
  only:
    - merge_requests
    - main
  tags:
    - docker

lint:helm:
  stage: lint
  image: alpine/helm:${HELM_VERSION}
  script:
    - helm lint k8s/charts/odoo/
  only:
    - merge_requests
    - main
  tags:
    - docker

lint:ansible:
  stage: lint
  image: cytopia/ansible-lint:latest
  script:
    - ansible-lint ansible/
  only:
    - merge_requests
    - main
  tags:
    - docker

lint:terraform:
  stage: lint
  image: hashicorp/terraform:latest
  script:
    - cd terraform
    - terraform init -backend=false
    - terraform validate
    - terraform fmt -check
  only:
    - merge_requests
    - main
  tags:
    - docker

lint:shellcheck:
  stage: lint
  image: koalaman/shellcheck-alpine:latest
  script:
    - shellcheck scripts/*.sh
  only:
    - merge_requests
    - main
  tags:
    - docker

test:bats:
  stage: test
  image: bats/bats:latest
  script:
    - cd scripts
    - bats tests/
  only:
    - merge_requests
    - main
  tags:
    - docker

# ============================================
# BUILD STAGE
# ============================================

build:odoo-custom:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      if [ -d "custom_modules" ]; then
        docker build -t $CI_REGISTRY_IMAGE/odoo:$CI_COMMIT_SHORT_SHA -f docker/Dockerfile.odoo .
        docker push $CI_REGISTRY_IMAGE/odoo:$CI_COMMIT_SHORT_SHA

        # Tag as latest on main branch
        if [ "$CI_COMMIT_BRANCH" == "main" ]; then
          docker tag $CI_REGISTRY_IMAGE/odoo:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE/odoo:latest
          docker push $CI_REGISTRY_IMAGE/odoo:latest
        fi
      else
        echo "No custom modules to build, using official Odoo image"
      fi
  only:
    - main
    - develop
    - tags
  tags:
    - docker

# ============================================
# TEST STAGE
# ============================================

test:unit:
  stage: test
  image: odoo:17.0
  services:
    - postgres:15
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_odoo
    POSTGRES_USER: odoo
    POSTGRES_PASSWORD: odoo
    HOST: postgres
  before_script:
    - apt-get update && apt-get install -y python3-pip
    - pip3 install pytest pytest-odoo coverage
  script:
    - |
      if [ -d "custom_modules" ]; then
        echo "Running unit tests for custom modules..."
        cd custom_modules
        pytest tests/ --junitxml=report.xml --cov=. --cov-report=xml --cov-report=term
      else
        echo "No custom modules to test"
      fi
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      junit: custom_modules/report.xml
      coverage_report:
        coverage_format: cobertura
        path: custom_modules/coverage.xml
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
  tags:
    - docker

test:integration:
  stage: test
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - *helm_install
  script:
    - |
      set -e
      kubectl create namespace test-odoo --dry-run=client -o yaml | kubectl apply -f -

      SECRET_VALUES_FILE_PATH=""
      if [ -n "$DEV_VALUES_SECRETS_B64" ]; then
        echo "$DEV_VALUES_SECRETS_B64" | base64 -d > k8s/overlays/dev/values-secrets.ci.yaml
        SECRET_VALUES_FILE_PATH="k8s/overlays/dev/values-secrets.ci.yaml"
      elif [ -f k8s/overlays/dev/values-secrets.yaml ]; then
        SECRET_VALUES_FILE_PATH="k8s/overlays/dev/values-secrets.yaml"
      fi

      VALUES_ARGS="-f k8s/overlays/dev/values.yaml"
      if [ -n "$SECRET_VALUES_FILE_PATH" ]; then
        VALUES_ARGS="$VALUES_ARGS -f $SECRET_VALUES_FILE_PATH"
      fi

      helm template odoo k8s/charts/odoo/ $VALUES_ARGS --namespace test-odoo > /tmp/manifest.yaml
      kubectl apply -f /tmp/manifest.yaml --dry-run=client
      echo "Manifest validation successful"
  after_script:
    - kubectl delete namespace test-odoo --ignore-not-found=true
  only:
    - merge_requests
    - main
  tags:
    - kubernetes

test:container-structure:
  stage: test
  image: gcr.io/gcp-runtimes/container-structure-test:latest
  script:
    - |
      if [ -d "custom_modules" ]; then
        container-structure-test test --image $CI_REGISTRY_IMAGE/odoo:$CI_COMMIT_SHORT_SHA --config docker/tests/container-structure-test.yaml
      else
        echo "Skipping container structure test - using official image"
      fi
  only:
    - main
    - develop
  tags:
    - docker
  allow_failure: true

test:helm-tests:
  stage: test
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - *helm_install
  script:
    - |
      set -e
      kubectl create namespace test-helm --dry-run=client -o yaml | kubectl apply -f -

      SECRET_VALUES_FILE_PATH=""
      if [ -n "$DEV_VALUES_SECRETS_B64" ]; then
        echo "$DEV_VALUES_SECRETS_B64" | base64 -d > k8s/overlays/dev/values-secrets.ci.yaml
        SECRET_VALUES_FILE_PATH="k8s/overlays/dev/values-secrets.ci.yaml"
      elif [ -f k8s/overlays/dev/values-secrets.yaml ]; then
        SECRET_VALUES_FILE_PATH="k8s/overlays/dev/values-secrets.yaml"
      fi

      VALUES_ARGS="-f k8s/overlays/dev/values.yaml"
      if [ -n "$SECRET_VALUES_FILE_PATH" ]; then
        VALUES_ARGS="$VALUES_ARGS -f $SECRET_VALUES_FILE_PATH"
      fi

      helm upgrade --install odoo-test k8s/charts/odoo/ \
        $VALUES_ARGS \
        --namespace test-helm \
        --wait --timeout 5m
      helm test odoo-test --namespace test-helm --logs
  after_script:
    - helm uninstall odoo-test --namespace test-helm || true
    - kubectl delete namespace test-helm --ignore-not-found=true
  only:
    - merge_requests
    - main
  tags:
    - kubernetes
  allow_failure: true

# ============================================
# SECURITY STAGE
# ============================================

security:trivy:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 0 --no-progress --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json $CI_REGISTRY_IMAGE/odoo:$CI_COMMIT_SHORT_SHA || true
    - trivy image --exit-code 0 --severity HIGH,CRITICAL --no-progress $CI_REGISTRY_IMAGE/odoo:$CI_COMMIT_SHORT_SHA
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  only:
    - main
    - develop
  tags:
    - docker
  allow_failure: true

security:kube-bench:
  stage: security
  image: aquasec/kube-bench:latest
  before_script:
    - *kubectl_config
  script:
    - kube-bench run --targets node,policies --json > kube-bench-report.json
  artifacts:
    paths:
      - kube-bench-report.json
    expire_in: 1 week
  only:
    - schedules
  tags:
    - kubernetes
  allow_failure: true

# ============================================
# DEPLOY DEV STAGE
# ============================================

deploy:dev:
  stage: deploy-dev
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - *helm_install
  script:
    - |
      set -e
      kubectl create namespace ${K8S_NAMESPACE_DEV} --dry-run=client -o yaml | kubectl apply -f -

      SECRET_VALUES_FILE_PATH=""
      if [ -n "$DEV_VALUES_SECRETS_B64" ]; then
        echo "$DEV_VALUES_SECRETS_B64" | base64 -d > k8s/overlays/dev/values-secrets.ci.yaml
        SECRET_VALUES_FILE_PATH="k8s/overlays/dev/values-secrets.ci.yaml"
      elif [ -f k8s/overlays/dev/values-secrets.yaml ]; then
        SECRET_VALUES_FILE_PATH="k8s/overlays/dev/values-secrets.yaml"
      fi

      VALUES_ARGS="-f k8s/overlays/dev/values.yaml"
      if [ -n "$SECRET_VALUES_FILE_PATH" ]; then
        VALUES_ARGS="$VALUES_ARGS -f $SECRET_VALUES_FILE_PATH"
      fi

      helm upgrade --install odoo-dev k8s/charts/odoo/ \
        $VALUES_ARGS \
        --namespace ${K8S_NAMESPACE_DEV} \
        --set image.tag=${CI_COMMIT_SHORT_SHA} \
        --wait --timeout 10m
      kubectl rollout status deployment -n ${K8S_NAMESPACE_DEV} -l app.kubernetes.io/name=odoo
  environment:
    name: development
    url: https://odoo-dev.local
    on_stop: stop:dev
  only:
    - develop
  tags:
    - kubernetes

smoke-test:dev:
  stage: deploy-dev
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - apk add --no-cache bash curl
  script:
    - bash scripts/smoke-tests.sh ${K8S_NAMESPACE_DEV}
  dependencies:
    - deploy:dev
  only:
    - develop
  tags:
    - kubernetes
  allow_failure: false

stop:dev:
  stage: deploy-dev
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
  script:
    - helm uninstall odoo-dev --namespace ${K8S_NAMESPACE_DEV} || true
  when: manual
  environment:
    name: development
    action: stop
  only:
    - develop
  tags:
    - kubernetes

# ============================================
# DEPLOY STAGE
# ============================================

deploy:stage:
  stage: deploy-stage
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - *helm_install
  script:
    - |
      set -e
      kubectl create namespace ${K8S_NAMESPACE_STAGE} --dry-run=client -o yaml | kubectl apply -f -

      SECRET_VALUES_FILE_PATH=""
      if [ -n "$STAGE_VALUES_SECRETS_B64" ]; then
        echo "$STAGE_VALUES_SECRETS_B64" | base64 -d > k8s/overlays/stage/values-secrets.ci.yaml
        SECRET_VALUES_FILE_PATH="k8s/overlays/stage/values-secrets.ci.yaml"
      elif [ -f k8s/overlays/stage/values-secrets.yaml ]; then
        SECRET_VALUES_FILE_PATH="k8s/overlays/stage/values-secrets.yaml"
      fi

      VALUES_ARGS="-f k8s/overlays/stage/values.yaml"
      if [ -n "$SECRET_VALUES_FILE_PATH" ]; then
        VALUES_ARGS="$VALUES_ARGS -f $SECRET_VALUES_FILE_PATH"
      fi

      helm upgrade --install odoo-stage k8s/charts/odoo/ \
        $VALUES_ARGS \
        --namespace ${K8S_NAMESPACE_STAGE} \
        --set image.tag=${CI_COMMIT_SHORT_SHA} \
        --wait --timeout 15m
      kubectl rollout status deployment -n ${K8S_NAMESPACE_STAGE} -l app.kubernetes.io/name=odoo
  environment:
    name: staging
    url: https://odoo-stage.local
    on_stop: stop:stage
  only:
    - main
  when: manual
  tags:
    - kubernetes

smoke-test:stage:
  stage: deploy-stage
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - apk add --no-cache bash curl
  script:
    - bash scripts/smoke-tests.sh ${K8S_NAMESPACE_STAGE}
  dependencies:
    - deploy:stage
  only:
    - main
  tags:
    - kubernetes
  when: on_success
  allow_failure: false

stop:stage:
  stage: deploy-stage
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
  script:
    - helm uninstall odoo-stage --namespace ${K8S_NAMESPACE_STAGE} || true
  when: manual
  environment:
    name: staging
    action: stop
  only:
    - main
  tags:
    - kubernetes

# ============================================
# DEPLOY PROD STAGE
# ============================================

deploy:prod:
  stage: deploy-prod
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - *helm_install
  script:
    - |
      set -e
      kubectl create namespace ${K8S_NAMESPACE_PROD} --dry-run=client -o yaml | kubectl apply -f -

      SECRET_VALUES_FILE_PATH=""
      if [ -n "$PROD_VALUES_SECRETS_B64" ]; then
        echo "$PROD_VALUES_SECRETS_B64" | base64 -d > k8s/overlays/prod/values-secrets.ci.yaml
        SECRET_VALUES_FILE_PATH="k8s/overlays/prod/values-secrets.ci.yaml"
      elif [ -f k8s/overlays/prod/values-secrets.yaml ]; then
        SECRET_VALUES_FILE_PATH="k8s/overlays/prod/values-secrets.yaml"
      fi

      VALUES_ARGS="-f k8s/overlays/prod/values.yaml"
      if [ -n "$SECRET_VALUES_FILE_PATH" ]; then
        VALUES_ARGS="$VALUES_ARGS -f $SECRET_VALUES_FILE_PATH"
      fi

      helm upgrade --install odoo-prod k8s/charts/odoo/ \
        $VALUES_ARGS \
        --namespace ${K8S_NAMESPACE_PROD} \
        --set image.tag=${CI_COMMIT_TAG} \
        --wait --timeout 20m
      kubectl rollout status deployment -n ${K8S_NAMESPACE_PROD} -l app.kubernetes.io/name=odoo
  environment:
    name: production
    url: https://odoo.yourdomain.com
  only:
    - tags
  when: manual
  tags:
    - kubernetes

smoke-test:prod:
  stage: deploy-prod
  image: alpine/helm:${HELM_VERSION}
  before_script:
    - *kubectl_config
    - apk add --no-cache bash curl
  script:
    - bash scripts/smoke-tests.sh ${K8S_NAMESPACE_PROD}
  dependencies:
    - deploy:prod
  only:
    - tags
  tags:
    - kubernetes
  when: on_success
  allow_failure: false

# ============================================
# PERFORMANCE TEST STAGE
# ============================================

performance:k6:
  stage: performance-test
  image: grafana/k6:latest
  script:
    - k6 run --vus 10 --duration 30s k8s/tests/load-test.js
  artifacts:
    reports:
      load_performance: k6-report.json
  only:
    - schedules
  tags:
    - docker
  allow_failure: true

performance:locust:
  stage: performance-test
  image: locustio/locust:latest
  script:
    - locust -f k8s/tests/locustfile.py --headless --users 100 --spawn-rate 10 --run-time 5m --host https://odoo-stage.local
  artifacts:
    paths:
      - locust_report.html
    expire_in: 1 week
  only:
    - schedules
  tags:
    - docker
  allow_failure: true
